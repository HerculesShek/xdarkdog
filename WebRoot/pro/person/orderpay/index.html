<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="keywords" content="嘿狗社区
" />
<meta name="description" content="嘿狗社区。" />
<title>嘿狗社区服务平台</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0">
<link type="text/css" rel="stylesheet" href="../../css/common.css" />
<script type="text/javascript" src="../../js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/fastclick.min.js"></script>
<script type="text/javascript" src="../../js/base.js"></script>
<script>
    //fastclick初始化
    window.addEventListener('load', function () {
        FastClick.attach(document.body);
    }, false);
</script>
    <link type="text/css" rel="stylesheet" href="../../css/pay.css" />
</head>
<body>
<div class="addAddrBox" style="display:none;">
	<iframe src="/haosi/index.php/weixin/addr/index.html" width="100%" height="100%" frameborder="0"></iframe>
</div>
<div class="container">
    <div class="header">
    	<a href="/haosi/index.php/weixin/lunch/index.html" class="left linkAct"><img class="m-t-4" src="../../images/arrow-left.png" width="30"/></a>
    	<h2>订单结算</h2>
    </div>
    <div class="manage-address"><h2 class="left">配送地址</h2><a class="linkAct red addAddrBtn" href="javascript:void(0)">管理地址</a></div>
    <div class="clr"></div>
        <div class="order-address-box" style="display:none;">
    	<div class="order-address-default linkAct">
    		<input type="hidden" name="addr_id" id="addr_id" value="" />
   			<h2></h2>
   			<p class="gray8"></p>
			<b class="order-address-arrow arrow-right"><img src="../../images/arrow.png" width="20"/></b>
    	</div>
    </div>
    <!-- 选择地址会话框 -->
   	<div class="dialog-wrap" style="display:none;">
	    <div class="dialog-shade"></div>
		<div class="dialog-box">
			<h3>选择送餐地址<a href="javascript:void(0)" class="dialog-close-btn linkAct"><img src="../../images/close.png" width="20"/></a></h3>
			<div class="dialog-content">
				<ul class="order-other-address">
		    		<li class="linkAct" onclick="changeAddr(this)" id="default-other-addr">
		    				<input type="hidden" class="address-id" ref="1356"/>
			    			<h2>杭州市滨江区浙江施强国际培训学院滨安璐1168号1111&nbsp;&nbsp;asd</h2>
			    			<p>13098190981</p>
		    			</li><li class="linkAct" onclick="changeAddr(this)" >
		    				<input type="hidden" class="address-id" ref="1355"/>
			    			<h2>杭州市滨江区国信嘉园滨盛路4056号33-1-802&nbsp;&nbsp;魏帅</h2>
			    			<p>18222891890</p>
		    			</li>		    	</ul>
			</div>
		</div>
	</div>
	<div class="order-pay-box-display">
	    <div class="manage-title"><h2>选择送餐时间</h2></div>
	    <div class="order-pay-time-wrap">
	    	<div class="order-pay-time">
	    		<div class="order-time-box">
	    			<div class="order-pay-time-select-left">
						<select class="order-pay-select select" id="order-pay-day" name="order_time">
					   		<option value="2014-10-12">2014-10-12&nbsp星期天</option><option value="2014-10-13">2014-10-13&nbsp星期一</option><option value="2014-10-14">2014-10-14&nbsp星期二</option>				   	  	</select>
			   	  	</div>
			   	  	<div class="order-pay-time-select-right">
				   	  	<select class="order-pay-select select" id="order-pay-time">
					   		<option value="1">中午送达</option>
					   		<option value="2">晚上送达</option>
					   	</select>
				   	</div>
	    		</div>
	    		<div class="clr"></div>
	    		<div class="order-favorable-wrap">
		    		<div class="order-favorable">
		    			<p class="mealsOnWheelsBox red"></p>
		    			<!-- <ul>
		    				<li class="favorable-50"><div class="c-box-off" id="mealsOnWheelsOn1"><b></b>配送费<font class="" ref="3"></font>元</div></li>
		    				<li class="favorable-50"><div class="c-box-off" id="mealsOnWheelsOn2"><b></b><font>免配送费</font></div></li>
		    				<li class="favorable-100"><div class="c-box-off" id="mealsOnWheelsOn3"><b></b><font ref="提前一天预定送营养汤，两天送酸奶，三天送水果"></font></div></li>
		    			</ul> -->
		    			<!-- <ul>
		    				<li class="favorable-100"><div class="c-box-on" id="mealsOnWheelsOn3"><b></b><font>提前预约享优惠：提前一天：减1元，两天：减2元，三天：减3元（每份套餐）</font></div></li>
		    			</ul> -->
		    		</div>
		    	</div>
		    	<div class="clr"></div>
		    	<!-- 
		    	<div class="offset-box">
			    	<p>使用红包：</p>
			    	<select class="order-pay-select medal-select select" name="offset_code" id="offset_code">
		          		<option value="" original-title="0">--请选择--</option>
		          				            </select>
	            </div>
	             -->
	    	</div>
	    </div>
	    <div class="clr"></div>
		 <!-- 选择地址会话框 结束 -->
	    <input type="hidden" value="">
	    <div class="manage-title"><h2>确认餐品信息</h2></div>
	    <div class="lunch-box order-pay-lunch-box">
		    <ul>
		    	<!-- 遍历订单 -->
		    	<li>
		                <div class="lunch-photo">
		                                       				<img width="85" height="85" alt="" src="http://www.mrhaosi.com/haosi./Uploads/Mobile/day_140916/201409161548185830.jpg">		                </div>
		                <div class="lunch-title"><h2>米饭</h2></div>
		                <div class="lunch-info">
		                    <div class="ui-grid-a">
		                        <div class="ui-block-a">
		                            <p class="lunch-font12"><font class="org">￥<i class="price">1.00</i></font>&nbsp;<span>￥<font class="font-through">1.00</font></span></p>
		                        </div>
		                        <div class="ui-block-b">
		                            <b class="item-btn item-plus"><img height="28" src="../../images/plus.png"/></b>
		                            <div class="item-btn-box" style="display:none;">
		                                <font class="item-text">0</font>
		                                		                                <input type="hidden" class="order-pay-type" name="order_id[]" value="22" ref="1" />
		                                <b class="item-btn item-minus"><img height="28" src="../../images/minus.png"/></b>
		                            </div>
		                        </div>
		                    </div>
		                </div>
		            </li>		    </ul>
		    <strong class="order-pay-tips red">注：套餐内已含米饭。</strong>
		</div>
	</div>
	<div class="clr"></div>
		<input type="hidden" class="order-pay-order-id" id="order_id" value="22" />
	<input type="hidden" class="order-pay-order-count" id="order_count" value="0" />
	<input type="hidden" id="order-pay-yhInput" value="0" />
    <div class="order-count-box">
		<div class="order-count-text left">实付款:<span class="org">￥<font class="toTalPrice">0.00</font></span></div>
		<div class="settlement-box"><input type="button" id="settlement" class="button btn-org order-payment-btn" value="确认下单"/></div>
   	</div>
</div>
</body>
<script type="text/javascript">
	$(function(){
		if($("#noadd").length > 0) {
			$(".order-address-box").hide();
		}else{
			$(".order-address-box").show();
		}
		$("#noadd").find("a").click(function() {
			$(".addAddrBox").find("iframe").attr("src","/haosi/index.php/weixin/addr/operateAddr.html");
			$(".order-pay-box-display").hide();
			$(".addAddrBox").show();
		})
		//初始化地址
		$(".order-address-default").find("h2").html($("#default-other-addr").find("h2").html());
		$(".order-address-default").find("p").html($("#default-other-addr").find("p").html());
		$(".order-address-default").find("#addr_id").val($("#default-other-addr").find(".address-id").attr("ref"));
		//会话框动态垂直居中
		$(window).resize(function(){ 
		    $(".dialog-box").css({ 
		        top: ($(window).height() - $(".dialog-box").outerHeight())/2 
		    });        
		}); 
		//弹出选择地址会话框
		$(".order-address-default").click(function() {
			$(".dialog-wrap").show();
			$(window).resize();
		})
		//关闭选择地址会话框
		$(".dialog-close-btn").click(function() {
			$(".dialog-wrap").hide();
		})
		
		//改变使用优惠
		$(".medal-select").change(
			function() {
				countPrices();
			}
		)
		
		//判断时间差（天数）返回相差天数（-1：当天，0：第二天）
		function compareTime(time){
			var dt = Date.parse(time.replace(/-/g,"/"));
		    var a = new Date(dt);//拿到的时间
		    var d = new Date();//当前时间
		    var date = a.getTime() - d.getTime(); //时间差的毫秒数
		    var days = Math.floor(date/(24*3600*1000)); //相差天数
			return days;
		}
		//获得用户选择时间
		$selDay = $("#order-pay-day").find("option:selected").text().substring(0,10);
		mealsOnWheels($selDay);
		$("#order-pay-day").change(
			function() {
				mealsOnWheels($("#order-pay-day").find("option:selected").text().substring(0,10));
			}
		);
		$("#order-pay-time").change(
			function() {
				var $timeSelected = $("#order-pay-time").find("option:selected").val();
				mealsOnWheels($("#order-pay-day").find("option:selected").text().substring(0,10));
				if($timeSelected == 2){
					$("#order-pay-time option").each(
						function() {
							$(this).attr("selected",false);
						}
					)
					var $dinnerSendTime = "晚餐配送时间：16:30 - 19:30；当日晚餐订餐时间：18:30截止";//晚餐配送时间段
					$(".mealsOnWheelsBox").html($dinnerSendTime);
					$("#order-pay-time option[value='"+$timeSelected+"']").attr("selected",true);
				}else if($timeSelected == 1){
					$("#order-pay-time option").each(
						function() {
							$(this).attr("selected",false);
						}
					)
					var $lunchSendTime = "午餐配送时间：11:00 - 13:30；当日午餐订餐时间：13:00截止<br />";//午餐配送时间段
					$(".mealsOnWheelsBox").html($lunchSendTime);
					$("#order-pay-time option[value='"+$timeSelected+"']").attr("selected",true);
				}
			}
		);
		
		//计算送餐时间判断配送优惠
		function mealsOnWheels(time){
			//获得当前时间
			var $d = new Date();
			var $h = $d.getHours();
			var $m = $d.getMinutes();
			var $box1 = $("#mealsOnWheelsOn1");
			var $box2 = $("#mealsOnWheelsOn2");
			var $box3 = $("#mealsOnWheelsOn3");
			//免配送费
			function mealsOnWheelsOn1(){
				/*
				$box1.attr("class","c-box-off");
				$box2.attr("class","c-box-on");
				$box3.attr("class","c-box-off");
				*/
			}
			//提前预定优惠
			function mealsOnWheelsOn2(data){
				/*
				$box1.attr("class","c-box-off");
				$box2.attr("class","c-box-on");
				$box3.attr("class","c-box-on");
				$box3.find("font").html(data);
				*/
			}
			//没有优惠
			function mealsOnWheelsOff(){
				/*
				$box1.attr("class","c-box-on");
				$box2.attr("class","c-box-off");
				$box3.attr("class","c-box-off");
				$box1.find("font").html($box1.find("font").attr("ref"));
				$box3.find("font").html($box3.find("font").attr("ref"));
				*/
			}
			//重置配送优惠
			mealsOnWheelsOff();
			//判断时间
			var $limitToDayTime = "10:30";//当天午餐提前订单优惠时间
			var $Htlmt = $limitToDayTime.substring(0,2);//当天中午优惠小时
			var $Mtlmt = $limitToDayTime.substring(3,5);//当天中午优惠分钟
			var $limitNightTime = "16:00";//当天晚餐提前订单优惠时间
			var $Hnlmt = $limitNightTime.substring(0,2);//当天晚上优惠小时
			var $Mnlmt = $limitNightTime.substring(3,5);//当天晚上优惠分钟
			var $noonTime = "13:00";//当天午餐下单截止时间
			var $HnTime = $noonTime.substring(0,2);//小时
			var $MnTime = $noonTime.substring(3,5);//分钟
			var $advOne = "赠送营养汤";//提前一天
			var $advTwo = "赠送酸奶";//提前两天
			var $advThree = "赠送水果";//提前三天
			//计算提前优惠价格
			function countYhPrice(num) {
				var yhPrice = 0;
				$(".order-pay-type").each(function() {
					if($(this).attr("ref") == 1 && $(this).val() != 22 && $(this).parents("li").find(".lunch-title").find("h2").html().indexOf("盖饭") == -1){
						yhPrice += parseFloat($(this).parents(".item-btn-box").find(".item-text").html()) * num;
					}
				})
				return yhPrice;
			}
			if(compareTime(time) >= 0){//判断后几天
				//初始化中午/晚上送达
				$("#order-pay-time").removeAttr("disabled");
				$("#order-pay-time").attr("class","order-pay-select select");
				$("#order-pay-time option[value='1']").attr("selected",true);
				$("#order-pay-time option[value='2']").attr("selected",false);
				if(compareTime(time) == 0){//提前一天
					yhPrice = countYhPrice(1);
					$("#order-pay-yhInput").val(yhPrice);
					mealsOnWheelsOn2($advOne);
				}else if(compareTime(time) == 1){//提前两天
					yhPrice = countYhPrice(2);
					$("#order-pay-yhInput").val(yhPrice);
					mealsOnWheelsOn2($advTwo);
				}else if(compareTime(time) == 2){//提前三天
					yhPrice = countYhPrice(3);
					$("#order-pay-yhInput").val(yhPrice);
					mealsOnWheelsOn2($advThree);
				}else{
					mealsOnWheelsOn2();
				}
			}else{//判断当天
				yhPrice = countYhPrice(0);
				$("#order-pay-yhInput").val(yhPrice);
				//初始化中午/晚上送达
				if($h == $HnTime){
					if($m >= $MnTime){
						$("#order-pay-time option[value='1']").attr("selected",false);
						$("#order-pay-time option[value='2']").attr("selected",true);
						$("#order-pay-time").attr("disabled","disabled"); 
						$("#order-pay-time").attr("class","order-pay-select-off select");
					}
				}
				if($h > $HnTime){
					$("#order-pay-time option[value='1']").attr("selected",false);
					$("#order-pay-time option[value='2']").attr("selected",true);
					$("#order-pay-time").attr("disabled","disabled"); 
					$("#order-pay-time").attr("class","order-pay-select-off select");
				}
				var $payTime = $("#order-pay-time").find("option:selected").val();
				if($payTime == 1){//1代表中午，计算中午的规则
					if($h == $Htlmt){//当前小时等于系统规定的时间小时
						if($m < $Mtlmt){//当前分钟小于系统规定的时间分钟
							mealsOnWheelsOn1();//免配送费
						}else{
							mealsOnWheelsOff();//没有优惠
						}
					}
					if($h < $Htlmt){//当前小时小于系统给定的时间小时
						mealsOnWheelsOn1();
					}
				}else{//计算晚上的规则
					if($h == $Hnlmt){//当前小时等于系统规定的时间小时
						if($m < $Mnlmt){//当前分钟小于系统规定的时间分钟
							mealsOnWheelsOn1();//免配送费
						}else{
							mealsOnWheelsOff();//没有优惠
						}
					}
					if($h < $Hnlmt){//当前小时小于系统给定的时间小时
						mealsOnWheelsOn1();
					}
				}
			}
			//判断午餐/晚餐显示相应配送时间
			var $timeSelected = $("#order-pay-time").find("option:selected").val();
			if($timeSelected == 2){
				var $dinnerSendTime = "晚餐配送时间：16:30 - 19:30；当日晚餐订餐时间：18:30截止";//晚餐配送时间段
				$(".mealsOnWheelsBox").html($dinnerSendTime);
			}else if($timeSelected == 1){
				var $lunchSendTime = "午餐配送时间：11:00 - 13:30；当日午餐订餐时间：13:00截止<br />";//午餐配送时间段
				$(".mealsOnWheelsBox").html($lunchSendTime);
			}
			countPrices();
		}

		var $plus = $(".item-plus");
		var $minus = $(".item-minus");
		//增加套餐数量
		$plus.live("click",function(){
			var $priceNum = $(this).next(".item-btn-box").find(".item-text");
			var $toTalNum = parseFloat($priceNum.html()) + 1;
			$priceNum.html($toTalNum);
			//计算优惠金额
			$selDay = $("#order-pay-day").find("option:selected").text().substring(0,10);
			mealsOnWheels($selDay);
			countPrices();
		});
		//减少套餐数量
		$minus.live("click",function(){
			var $priceNum = $(this).parents(".item-btn-box").find(".item-text");
			if(parseFloat($priceNum.html()) > 0){
				var $toTalNum = parseFloat($priceNum.html()) - 1;
				$priceNum.html($toTalNum);
				//计算优惠金额
				$selDay = $("#order-pay-day").find("option:selected").text().substring(0,10);
				mealsOnWheels($selDay);
				countPrices();
			}
		});

		//操作数量集合
		function countNumParams(data,num){
			var $idParams = $("#order_id").val().split(',');
			var $countParams = $("#order_count").val().split(',');
			var $thisOrderId = data.parents(".ui-block-b").find(".order-pay-type").val();
			for(var i = 0; i<$idParams.length; i++){
				if($idParams[i] == $thisOrderId){
					
					$countParams[i] =  num;
					var newarry = $countParams.join(',');
					$("#order_count").val(newarry);
				}
			}
		}
		//计算最终的数量和价格和初始化
		function countPrices() {
			//如果数量套餐数量等于0隐藏元素
			$(".item-text").each(function() {
				if(parseFloat($(this).html()) > 0){
					$(this).parents(".item-btn-box").show();
				}else{
					$(this).parents(".item-btn-box").hide();
				}
				//调用改变ID和COUNT数组方法
				countNumParams($(this),parseFloat($(this).html()));
			})
			
			//判断所有套餐类型的数量
			var orderTypeCount = 0;
			$(".order-pay-type").each(function() {
				if($(this).attr("ref") == "1" && $(this).val() != "22"){
					var typeNum = parseFloat($(this).parents(".item-btn-box").find(".item-text").html());
					orderTypeCount = typeNum + orderTypeCount;
				}
			})
			if(orderTypeCount < 1){
				$("#settlement").attr("class","button btn-gray order-payment-btn");
			}else{
				$("#settlement").attr("class","button btn-org order-payment-btn");
			}
			var $toTalPrice = 0;//总价格
			//计算总价格
			$(".price").each(function() {
				var $fPrice = parseFloat($(this).html()) * parseFloat($(this).parents(".lunch-info").find(".item-text").html());
				$toTalPrice = $toTalPrice + $fPrice;
			});
			if($("#mealsOnWheelsOn1").attr("class") == "c-box-on"){
				$toTalPrice = parseFloat($("#mealsOnWheelsOn1").find("font").html()) + $toTalPrice;
			}
			//var $medalPrice = $(".medal-select").find("option:selected").attr("original-title");//勋章抵扣券价格
			//$toTalPrice = $toTalPrice - parseFloat($medalPrice);
			
			//var $yhPrice = $("#order-pay-yhInput").val();//优惠价格
			//$toTalPrice = $toTalPrice - parseFloat($yhPrice);
			
			$toTalPrice = $toTalPrice.toFixed(2);
			if($toTalPrice > 0){
				$(".toTalPrice").html($toTalPrice);
			}else{
				$(".toTalPrice").html("0.00");
			}
			$(".order-pay-day-default").html($("#order-pay-day").find("option:selected").text());
			$(".order-pay-time-default").html($("#order-pay-time").find("option:selected").text());
			
		}
		
		//提交信息
		var state = true;
		$(".order-payment-btn").click(function(){
			$typeTemp = false;
			$typeMessage = "请至少添加一份套餐";
			$addrMessage = "您还没有选择配送地址";
			
			var orderTypeCount = 0;
			$(".order-pay-type").each(function() {
				if($(this).attr("ref") == "1" && $(this).val() != "22"){
					var typeNum = parseFloat($(this).parents(".item-btn-box").find(".item-text").html());
					orderTypeCount = typeNum + orderTypeCount;
				}
			})
			if(orderTypeCount > 0){
				$typeTemp = true;
			}
			if($(".order-address-default").find("input[name='addr_id']").val() == ""){
				alert($addrMessage);
				return false;
			}
			if(!$typeTemp){
				alert($typeMessage);
				return false;
			}
			if(state){//防止ajax重复提交
				state = false;
			}else{
				return false;
			}
			
			$.ajax({
				url:"/haosi/index.php/weixin/orderpay/choosePay.html",
				type:"post",
				data:{addr_id:$("#addr_id").val(),ids:$(".order-pay-order-id").val(),counts:$(".order-pay-order-count").val(),order_time:$("#order-pay-day").val(),is_lunch:$("#order-pay-time").val()},
				success:function(json){
					state = true;
					$(".order-payment-btn").attr('disable','disable');
					var data = eval("("+json+")");
					if(data.status == 1){
						var COOKIE_NAME = 'mobileCart';
						$.cookie(COOKIE_NAME, null, { path: '/' });  //删除cookie
						window.location.href = "/haosi/Weixin/Orderpay/success/code/"+data.data;
					}else if(data.status == 3){
						alert(data.info);
					}else{
						alert(data.info);
					}
				},
				error:function(data){
					state = true;
				}
			})
		})
		$(".addAddrBtn").click(function() {
			$(".order-pay-box-display").hide();
			$(".addAddrBox").show();
		})
	})
	
	//点击后调换地址
	function changeAddr(t) {
		var otherAddr = $(t).find("h2").html();
		var otherTel = $(t).find("p").html();
		var otherId = $(t).find(".address-id").attr("ref");
		
		var mainAddr = $(".order-address-default").find("h2").html();
		var mainTel = $(".order-address-default").find("p").html();
		var mainId = $(".order-address-default").find("#addr_id").val();
		
		$(t).find("h2").html(mainAddr);
		$(t).find("p").html(mainTel);
		$(t).find(".address-id").attr("ref",mainId);
		
		$(".order-address-default").find("h2").html(otherAddr);
		$(".order-address-default").find("p").html(otherTel);
		$(".order-address-default").find("#addr_id").val(otherId);
		$(".dialog-wrap").hide();
	}
	
	function closeIframe(){
		$(".order-pay-box-display").show();
		$(".addAddrBox").hide();
	}
	//用于iframe子页面测试
	function testAddr(){
		return 1;
	}
	function refreshAddrIframe(){
		$(".order-pay-box-display").show();
		$(".addAddrBox").hide();
		refreshAddr();
	}
	$(".refresh").click(function() {
		refreshAddr();
	})
	/*刷新地址*/
	function refreshAddr(){
		$.ajax({
			url:"/haosi/index.php/weixin/addr/refreshAddr.html",
			type:"post",
			data:'',
			success:function(json){
				var data = eval("("+json+")");
				if(data.status == 1){
					$(".order-other-address").find("li").remove();
					var jsonData = data.data;
					if(jsonData.length > 0){
						$(".order-address-box").show();
						$("#noadd").remove();
					}
					for(var i=0; i<jsonData.length; i++)
				  	{  
			    		if(jsonData[i].ismain == 1){
							$(".order-other-address").append('<li class="linkAct" onclick="changeAddr(this)" id="default-other-addr"><input type="hidden" class="address-id" ref="'+jsonData[i].id+'"/><h2>'+jsonData[i].city_name+jsonData[i].area_name+jsonData[i].high_rise+jsonData[i].street+jsonData[i].addr+'&nbsp;&nbsp;'+jsonData[i].contact+'</h2><p>'+jsonData[i].contactTel+'</p></li>');
						}else{
							$(".order-other-address").append('<li class="linkAct" onclick="changeAddr(this)"><input type="hidden" class="address-id" ref="'+jsonData[i].id+'"/><h2>'+jsonData[i].city_name+jsonData[i].area_name+jsonData[i].high_rise+jsonData[i].street+jsonData[i].addr+'&nbsp;&nbsp;'+jsonData[i].contact+'</h2><p>'+jsonData[i].contactTel+'</p></li>');
						}
				        //alert("text:"+data[o].name+" value:"+data[o].age );  
			      	}  
				}
				$(".order-address-default").find("h2").html($("#default-other-addr").find("h2").html());
				$(".order-address-default").find("p").html($("#default-other-addr").find("p").html());
				$(".order-address-default").find("#addr_id").val($("#default-other-addr").find(".address-id").attr("ref"));
			},
			error:function(data){
			}
		})
	}
</script>
</html>